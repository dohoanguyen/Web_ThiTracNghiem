@model Web_KLCN.Models.BaiThiViewModel
@{
    ViewBag.Title = "Xem lại bài làm";
    Layout = "~/Views/Shared/LayoutPage.cshtml";

    // LẤY TRẠNG THÁI XEM ĐÁP ÁN TỪ LỊCH THI
    bool XemDapAn = Model.XemDapAn;

    // Khai báo một số màu Tailwind tương ứng
    string colorSuccess = "border-green-500 bg-green-50 dark:bg-green-900/50";
    string colorDanger = "border-red-500 bg-red-50 dark:bg-red-900/50";
    string colorWarning = "border-yellow-500 bg-yellow-50 dark:bg-yellow-900/50";
    string colorDefault = "border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800";
}

<div class="container mx-auto py-8 px-4 animate-fadeIn">
    <h3 class="text-3xl font-bold mb-6 text-primary">
        <span class="material-symbols-outlined align-middle me-2 text-2xl">visibility</span> Xem lại bài làm: @Model.TenDe
    </h3>

    <div class="p-4 rounded-xl shadow-lg mb-6 bg-white dark:bg-surface-dark border border-gray-100 dark:border-gray-700">
        <div class="flex items-center mb-1 text-text-light dark:text-text-dark">
            <span class="material-symbols-outlined text-green-500 me-2">check_circle</span>
            <b class="font-semibold">Số câu đúng:</b> <span class="ml-1">@Model.SoCauDung / @Model.CauHoiList.Count</span>
        </div>
        <div class="flex items-center text-text-light dark:text-text-dark">
            <span class="material-symbols-outlined text-amber-500 me-2">grade</span>
            <b class="font-semibold">Điểm:</b> <span class="ml-1 text-xl font-bold text-primary">@Model.Diem</span>
        </div>
    </div>

    @for (int i = 0; i < Model.CauHoiList.Count; i++)
    {
        var c = Model.CauHoiList[i];
        bool boQua = string.IsNullOrWhiteSpace(c.DapAnChon) || c.DapAnChon.Trim().ToUpper() == "NULL";

        <div class="card bg-white dark:bg-surface-dark shadow-xl rounded-xl mb-6 p-6 transition-transform duration-300 hover:shadow-2xl hover:scale-[1.005]">
            <h4 class="text-xl font-bold mb-4 text-text-light dark:text-text-dark">Câu @(i + 1): @c.NoiDung</h4>

            @if (c.MaP == 1 || c.MaP == 2)
            {
                // Danh sách các tùy chọn đáp án (Cho cả MaP=1 và MaP=2)
                var options = c.MaP == 1
                    ? new[] {
                        Tuple.Create("A", c.DapAnA),
                        Tuple.Create("B", c.DapAnB),
                        Tuple.Create("C", c.DapAnC),
                        Tuple.Create("D", c.DapAnD)
                        }.Where(t => !string.IsNullOrWhiteSpace(t.Item2)).ToList()
                    : (c.ListYDung?.Select(y => Tuple.Create(y.MaPhuongAn, y.NoiDung)).ToList() ?? new List<Tuple<string, string>>());

                <ul class="space-y-2 mb-4">
                    @foreach (var opt in options)
                    {
                        string noiDung = opt.Item2.Trim();
                        string maPhuongAn = c.MaP == 1 ? noiDung : opt.Item1.Trim(); // MaP=1 dùng Nội dung để so sánh, MaP=2 dùng Mã (A, B, C...)

                        string dapAnChon = (c.DapAnChon ?? "").Trim();
                        bool daChon = c.MaP == 1
                            ? (!string.IsNullOrWhiteSpace(dapAnChon) && string.Equals(noiDung, dapAnChon, StringComparison.OrdinalIgnoreCase))
                            : (c.DapAnChonList?.Contains(maPhuongAn, StringComparer.OrdinalIgnoreCase) ?? false);

                        string dapAnDung = (c.DapAnDung ?? "").Trim();
                        bool laDung = c.MaP == 1
                            ? (!string.IsNullOrWhiteSpace(dapAnDung) && string.Equals(noiDung, dapAnDung, StringComparison.OrdinalIgnoreCase))
                            : (c.ListYDung?.FirstOrDefault(y => y.MaPhuongAn.Equals(maPhuongAn, StringComparison.OrdinalIgnoreCase))?.DungSai == 1);

                        string itemClass = colorDefault; // Mặc định: border-gray

                        if (XemDapAn)
                        {
                            if (daChon && laDung) // Đã chọn VÀ Đúng
                            { itemClass = colorSuccess; }
                            else if (daChon && !laDung) // Đã chọn NHƯNG Sai
                            { itemClass = colorDanger; }
                            else if (!daChon && laDung) // KHÔNG chọn NHƯNG Đúng (Đáp án bị bỏ qua)
                            { itemClass = colorWarning; }
                        }
                        else // KHÔNG cho xem đáp án
                        {
                            if (daChon) // Chỉ tô màu đáp án đã chọn (luôn là đỏ vì bài đã kết thúc)
                            { itemClass = colorDanger; }
                        }

                        <li class="p-3 rounded-lg border-2 @itemClass text-text-light dark:text-text-dark transition-colors">
                            <span class="font-semibold text-primary me-2">@opt.Item1.ToUpper().</span> @opt.Item2
                        </li>
                    }
                </ul>
            }

            @if (c.MaP == 3)
            {
                bool dung = !boQua && string.Equals(
                    (c.DapAnChon ?? "").Replace(" ", "").Trim(),
                    (c.DapAnDung ?? "").Replace(" ", "").Trim(),
                    StringComparison.OrdinalIgnoreCase);

                string borderStyle;
                string inputClass = "textarea w-full font-semibold resize-none ";

                if (XemDapAn)
                {
                    if (boQua) { borderStyle = "border-gray-400"; }
                    else if (dung) { borderStyle = "border-green-500 border-4"; inputClass += " bg-green-50 dark:bg-surface-dark/80 "; }
                    else { borderStyle = "border-red-500 border-4"; inputClass += " bg-red-50 dark:bg-surface-dark/80 "; }
                }
                else
                {
                    if (boQua) { borderStyle = "border-gray-400"; }
                    else { borderStyle = "border-red-500 border-4"; inputClass += " bg-red-50 dark:bg-surface-dark/80 "; }
                }

                <textarea class="@inputClass @borderStyle" rows="3" readonly>@(boQua ? "[Chưa làm]" : c.DapAnChon)</textarea>
            }

            <div class="space-y-2 mt-4">
                <div class="p-3 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 text-sm text-text-light dark:text-text-dark">
                    <b class="font-semibold">Đáp án đúng:</b>
                    @if (XemDapAn)
                    {
                        if (c.MaP == 1 || c.MaP == 3)
                        {
                            <span class="font-bold text-green-600 ml-1">@c.DapAnDung</span>
                        }
                        else if (c.MaP == 2)
                        {
                            var dapAnDungPhan2 = c.ListYDung
                                .Where(d => d.DungSai == 1)
                                .Select(d => d.MaPhuongAn.Trim())
                                .ToList();
                            if (dapAnDungPhan2.Any())
                            {
                                <span class="font-bold text-green-600 ml-1">@string.Join(", ", dapAnDungPhan2)</span>
                            }
                        }
                    }
                    else
                    {
                        <span class="text-red-500 font-bold ml-1">Không được xem đáp án đúng</span>
                    }
                </div>

                @if (!string.IsNullOrEmpty(c.GiaiThich) && XemDapAn)
                {
                    <div class="p-3 rounded-lg bg-yellow-50 dark:bg-yellow-950 border border-yellow-300 dark:border-yellow-800 text-sm text-text-light dark:text-text-dark">
                        <b class="font-semibold text-yellow-800 dark:text-yellow-300">Giải thích:</b> <span class="ml-1">@c.GiaiThich</span>
                    </div>
                }

                @if (boQua)
                {
                    <div class="p-3 rounded-lg bg-blue-50 dark:bg-blue-950 border border-blue-300 dark:border-blue-800 text-sm text-blue-800 dark:text-blue-300">
                        <span class="material-symbols-outlined text-base align-bottom me-2">info</span>
                        Bạn đã **bỏ qua** câu hỏi này.
                    </div>
                }
            </div>
        </div>
    }
</div>